name: Forked PR
on: [push]

jobs:
  amazonlinux-2-build:
    name: Amazon Linux-2 | Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
        with:
          submodules: recursive
      - name: Build
        run: | 
          git submodule update --init --recursive --force
          ./.cicd/build.sh
          tar -pczf build.tar.gz build
        env:
          IMAGE_TAG: amazon_linux-2-pinned
          PLATFORM_TYPE: pinned
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v1
        with:
          name: amazonlinux-2-build
          path: build.tar.gz
  amazonlinux-2-parallel-test:
    name: Amazon Linux-2 | Parallel Test
    runs-on: ubuntu-latest
    needs: amazonlinux-2-build
    steps:
      - uses: actions/checkout@v1
        with:
          submodules: recursive
      - name: Download Build Artifact
        uses: actions/download-artifact@v1
        with:
          name: amazonlinux-2-build
      - name: Parallel Test
        run: | 
          git submodule update --init --recursive --force
          tar -xzf build.tar.gz
          ./.cicd/test.sh scripts/parallel-test.sh
        env:
          IMAGE_TAG: amazon_linux-2-pinned
          PLATFORM_TYPE: pinned

  centos-77:
    name: Build Centos-7.7
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
        with:
          submodules: recursive
      - name: Build
        run: | 
          git submodule update --init --recursive --force
          ./.cicd/build.sh
        env:
          IMAGE_TAG: centos-7.7-pinned
          PLATFORM_TYPE: pinned

  ubuntu-1604:
    name: Build Ubuntu-16
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
        with:
          submodules: recursive
      - name: Build
        run: | 
          git submodule update --init --recursive --force
          ./.cicd/build.sh
        env:
          IMAGE_TAG: ubuntu-16.04-pinned
          PLATFORM_TYPE: pinned

  ubuntu-1804:
    name: Build Ubuntu-18
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
        with:
          submodules: recursive
      - name: Build
        run: | 
          git submodule update --init --recursive --force
          ./.cicd/build.sh
        env:
          IMAGE_TAG: ubuntu-18.04-pinned
          PLATFORM_TYPE: pinned

  macos-1015:
    name: Build MacOS-10.15
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v1
        with:
          submodules: recursive
      - name: Build
        run: | 
          git submodule update --init --recursive --force
          ./.cicd/platforms/unpinned/macos-10.14-unpinned.sh
          ./.cicd/build.sh
