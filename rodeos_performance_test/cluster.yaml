version: "3.9"
x-manager-node: &manager-node
    placement:
        constraints:
          - "node.role==manager"
services:
   loki:
      deploy:
         mode: replicated
         replicas: 1

   prometheus:
      deploy:
         placement:
            constraints:
            - node.role==manager
         restart_policy:
            condition: on-failure
   
   node-exporter:
      deploy:
         mode: global
         restart_policy:
            condition: on-failure
   
   alertmanager:
      deploy:
         placement:
            constraints:
               - node.role==manager
         restart_policy:
            condition: on-failure    
   
   cadvisor:
      deploy:
         mode: global
         restart_policy:
            condition: on-failure

   grafana:
      volumes:
         - ./configs/grafana-dashboards/dashboard-swarm.json:/var/lib/grafana/dashboards/dashboard.json
      deploy:
        <<: *manager-node

   bootstrap:
      deploy:
        <<: *manager-node
        restart_policy:
          condition: none

   jaeger-collector:
      deploy:
        <<: *manager-node
   jaeger-query:
      deploy:
        <<: *manager-node
   jaeger-agent:
      deploy:
        <<: *manager-node
   elasticsearch:
      deploy:
        <<: *manager-node
   producer: 
      deploy:
        <<: *manager-node
   ship:
      deploy:
         placement:
            constraints:
               - "node.labels.name==node-1"
   rodeos:
      deploy:
         placement:
            constraints:
               - "node.labels.name==node-2"
